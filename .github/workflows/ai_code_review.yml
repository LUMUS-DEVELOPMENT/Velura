name: AI Code Review v0.0.1

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - dev
      - crow613/velura
      - vardanm1993
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Run AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f Ai/Review/requirements.txt ]; then
            pip install -r Ai/Review/requirements.txt
          else
            echo "‚ö†Ô∏è requirements.txt not found ‚Äî skipping."
          fi

      - name: ü§ñ Run AI Review
        env:
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          echo "Running AI Code Review..."
          python Ai/Review/review.py \
            --project_dir="./" \
            --extensions ".py" ".js" ".php" ".vue" ".html" ".css" \
            --output="Ai/Review/review_results.txt"

      - name: üí¨ Comment PR with AI Review
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          python - <<'EOF'
          import os
          from github import Github

          token = os.environ["GITHUB_TOKEN"]
          repo_name = os.environ["GITHUB_REPOSITORY"]
          ref = os.environ["GITHUB_REF"]

          # PR number from refs/pull/123/merge
          try:
              pr_number = int(ref.split('/')[-2])
          except:
              pr_number = int(ref.split('/')[-1])

          g = Github(token)
          repo = g.get_repo(repo_name)
          pr = repo.get_pull(pr_number)

          try:
              with open("Ai/Review/review_results.txt", "r", encoding="utf-8") as f:
                  text = f.read()
          except FileNotFoundError:
              text = "‚ö†Ô∏è –§–∞–π–ª review_results.txt –Ω–µ –Ω–∞–π–¥–µ–Ω."

          text = text.strip()[:65000]
          pr.create_issue_comment(f"ü§ñ **AI Code Review Results**\n\n{text}")
          print("‚úÖ Successfully posted AI review comment.")
          EOF
      - name: Show AI Review
        run: cat Ai/Review/review_results.txt

